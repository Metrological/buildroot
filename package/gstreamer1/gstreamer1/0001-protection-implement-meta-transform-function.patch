From d47ec43e5d29eea15b8702a361d8dd6efb55e810 Mon Sep 17 00:00:00 2001
From: Philippe Normand <philn@igalia.com>
Date: Tue, 19 May 2015 18:58:11 +0200
Subject: [PATCH] protection: implement meta transform function

Copy the GstMeta contents over to the new buffer.

https://bugzilla.gnome.org/show_bug.cgi?id=749590
---
 gst/gstprotection.c | 24 ++++++++++++++++++++++--
 1 file changed, 22 insertions(+), 2 deletions(-)

diff --git a/gst/gstprotection.c b/gst/gstprotection.c
index c5223ee..af8081f 100644
--- a/gst/gstprotection.c
+++ b/gst/gstprotection.c
@@ -84,6 +84,27 @@ gst_protection_meta_free (GstMeta * meta, GstBuffer * buffer)
     gst_structure_free (protection_meta->info);
 }
 
+static gboolean
+gst_protection_meta_transform (GstBuffer * transbuf, GstMeta * meta,
+    GstBuffer * buffer, GQuark type, gpointer data)
+{
+  GstProtectionMeta *protection_meta = (GstProtectionMeta *) meta;
+
+  if (GST_META_TRANSFORM_IS_COPY (type)) {
+    GstMetaTransformCopy *copy = data;
+    if (!copy->region) {
+      /* only copy if the complete data is copied as well */
+      gst_buffer_add_protection_meta (transbuf,
+          gst_structure_copy (protection_meta->info));
+    } else
+      return FALSE;
+  } else {
+    /* transform type not supported */
+    return FALSE;
+  }
+  return TRUE;
+}
+
 const GstMetaInfo *
 gst_protection_meta_get_info (void)
 {
@@ -93,8 +114,7 @@ gst_protection_meta_get_info (void)
     const GstMetaInfo *meta =
         gst_meta_register (GST_PROTECTION_META_API_TYPE, "GstProtectionMeta",
         sizeof (GstProtectionMeta), gst_protection_meta_init,
-        gst_protection_meta_free,
-        (GstMetaTransformFunction) NULL);
+        gst_protection_meta_free, gst_protection_meta_transform);
 
     g_once_init_leave (&protection_meta_info, meta);
   }
-- 
2.1.4

