From 87446ab0c567b257ff6fd06dd6b31a210140d3e2 Mon Sep 17 00:00:00 2001
From: Arun Raghavan <arun@centricular.com>
Date: Fri, 23 Jan 2015 20:10:33 +0530
Subject: [PATCH 7/7] singledecodebin: Add a parse-only mode

https://bugzilla.gnome.org/show_bug.cgi?id=743511
---
 gst/singledecodebin/gstsingledecodebin.c | 76 ++++++++++++++++++++++++++++++++
 gst/singledecodebin/gstsingledecodebin.h |  2 +
 2 files changed, 78 insertions(+)

diff --git a/gst/singledecodebin/gstsingledecodebin.c b/gst/singledecodebin/gstsingledecodebin.c
index 0652ad4..d5f0834 100644
--- a/gst/singledecodebin/gstsingledecodebin.c
+++ b/gst/singledecodebin/gstsingledecodebin.c
@@ -29,6 +29,8 @@
 #include "config.h"
 #endif
 
+#include <string.h>
+
 #include "gstsingledecodebin.h"
 
 #define parent_class gst_single_decode_bin_parent_class
@@ -49,6 +51,46 @@ static GstStaticPadTemplate src_template = GST_STATIC_PAD_TEMPLATE ("src",
     GST_STATIC_CAPS ("ANY")
     );
 
+enum
+{
+  PROP_0,
+  PROP_PARSE_ONLY,
+};
+
+#define DEFAULT_PARSE_ONLY FALSE
+
+static void
+gst_single_decode_bin_get_property (GObject * object, guint prop_id,
+    GValue * value, GParamSpec * pspec)
+{
+  GstSingleDecodeBin *sdbin = GST_SINGLE_DECODE_BIN (object);
+
+  switch (prop_id) {
+    case PROP_PARSE_ONLY:
+      g_value_set_boolean (value, sdbin->parse_only);
+      break;
+    default:
+      G_OBJECT_WARN_INVALID_PROPERTY_ID (object, prop_id, pspec);
+      break;
+  }
+}
+
+static void
+gst_single_decode_bin_set_property (GObject * object, guint prop_id,
+    const GValue * value, GParamSpec * pspec)
+{
+  GstSingleDecodeBin *sdbin = GST_SINGLE_DECODE_BIN (object);
+
+  switch (prop_id) {
+    case PROP_PARSE_ONLY:
+      sdbin->parse_only = g_value_get_boolean (value);
+      break;
+    default:
+      G_OBJECT_WARN_INVALID_PROPERTY_ID (object, prop_id, pspec);
+      break;
+  }
+}
+
 static void
 dbin_pad_added_cb (GstElement * dbin, GstPad * pad,
     gpointer user_data G_GNUC_UNUSED)
@@ -67,6 +109,28 @@ dbin_pad_added_cb (GstElement * dbin, GstPad * pad,
   gst_object_unref (srcpad);
 
   sdbin->connected = TRUE;
+  sdbin->parse_only = DEFAULT_PARSE_ONLY;
+}
+
+static gboolean
+dbin_autoplug_continue_cb (GstElement * dbin, GstPad * pad, GstCaps * caps,
+    gpointer * user_data)
+{
+  GstSingleDecodeBin *sdbin = GST_SINGLE_DECODE_BIN (user_data);
+  GstStructure *s;
+  gboolean parsed = FALSE;
+
+  if (!sdbin->parse_only)
+    return TRUE;
+
+  /* We will only get fixed caps in autoplug-continue */
+  s = gst_caps_get_structure (caps, 0);
+  if (gst_structure_get_boolean (s, "parsed", &parsed) && parsed) {
+    /* A parser has been plugged in and that's all that we want */
+    return FALSE;
+  }
+
+  return TRUE;
 }
 
 static void
@@ -80,6 +144,8 @@ gst_single_decode_bin_init (GstSingleDecodeBin * sdbin)
 
   g_signal_connect (decodebin, "pad-added", G_CALLBACK (dbin_pad_added_cb),
       NULL);
+  g_signal_connect (decodebin, "autoplug-continue",
+      G_CALLBACK (dbin_autoplug_continue_cb), sdbin);
 
   gst_bin_add (GST_BIN (sdbin), decodebin);
 
@@ -92,13 +158,23 @@ gst_single_decode_bin_init (GstSingleDecodeBin * sdbin)
       gst_ghost_pad_new_no_target ("src", GST_PAD_SRC));
 
   sdbin->connected = FALSE;
+  sdbin->parse_only = FALSE;
 }
 
 static void
 gst_single_decode_bin_class_init (GstSingleDecodeBinClass * sdbin_class)
 {
+  GObjectClass *object_class = G_OBJECT_CLASS (sdbin_class);
   GstElementClass *element_class = GST_ELEMENT_CLASS (sdbin_class);
 
+  object_class->set_property = gst_single_decode_bin_set_property;
+  object_class->get_property = gst_single_decode_bin_get_property;
+
+  g_object_class_install_property (object_class, PROP_PARSE_ONLY,
+      g_param_spec_boolean ("parse-only", "Parse only",
+          "Only parse the given stream", DEFAULT_PARSE_ONLY,
+          G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
+
   gst_element_class_set_static_metadata (element_class, "Single Decode Bin",
       "Decoder/Bin", "Decode a single stream",
       "Arun Raghavan <arun@centricular.com>");
diff --git a/gst/singledecodebin/gstsingledecodebin.h b/gst/singledecodebin/gstsingledecodebin.h
index 3b52d3d..5f56ea0 100644
--- a/gst/singledecodebin/gstsingledecodebin.h
+++ b/gst/singledecodebin/gstsingledecodebin.h
@@ -24,7 +24,9 @@ G_BEGIN_DECLS
 
 typedef struct {
   GstBin parent;
+
   gboolean connected;
+  gboolean parse_only;
 } GstSingleDecodeBin;
 
 typedef struct {
-- 
2.1.4

